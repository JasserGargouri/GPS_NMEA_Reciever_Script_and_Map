<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS NMEA Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <style>
        body {
            display: flex;
            flex-direction: row;
            height: 100vh;
            margin: 0;
        }
        #controls {
            flex: 1;
            padding: 20px;
        }
        #map {
            flex: 4;
            height: 100%;
        }
        #timer {
            font-size: 1.5em;
        }
        #traceList {
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div id="controls">
        <h2>GPS 1</h2>
        <h2>GPS 1 <span id="gps1Status" style="color: red">&#11044;</span></h2>
        <label for="addressInput1">Address:</label>
        <input type="text" id="addressInput1" placeholder="Enter GPS Address">
        <label for="portInput1">Port:</label>
        <input type="number" id="portInput1" placeholder="Enter GPS Port">
        <button id="connectBtn1">Connect to GPS 1</button>
        <h2>GPS 2</h2>
        <h2>GPS 2 <span id="gps2Status" style="color: red">&#11044;</span></h2>
        <label for="addressInput2">Address:</label>
        <input type="text" id="addressInput2" placeholder="Enter GPS Address">
        <label for="portInput2">Port:</label>
        <input type="number" id="portInput2" placeholder="Enter GPS Port">
        <button id="connectBtn2">Connect to GPS 2</button>
        <button id="stopAllBtn" onclick="stopAllGPS()">Stop All GPS</button>
        <button id="startBtn" disabled>Start Recording</button>
        <button id="stopBtn" disabled>Stop Recording</button>
        <button id="browseTracesBtn">Browse Traces</button>
        <button id="resetButton">Reset Lines</button>
        <p id="timer">Time: 0s</p>
        <p id="recordingTime"></p>
        <input type="file" id="traceFileInput" accept=".csv">
        <button id="uploadTraceBtn">Upload Trace</button>
        <div id="traceList"></div>
        <p id="traceDuration">Duration: N/A</p>
        <p id="traceDistance">Distance: N/A</p>
    </div>
    <div id="map"></div>
    <script>
        const map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);
        let marker1 = L.marker([0, 0]).addTo(map);
        let marker2 = L.marker([0, 0], {color: 'red'}).addTo(map);
        let tracePolyline1 = L.polyline([], {color: 'blue'}).addTo(map);
        let tracePolyline2 = L.polyline([], {color: 'red'}).addTo(map);
        let timerInterval = null;
        let timeElapsed = 0;

        let device1Path = [];
        let device2Path = [];
        let mapUpdateEnabled = true;  // Flag to control real-time map updates

        async function updateMap() {

            if (!mapUpdateEnabled) {
            return;  // Exit if map updates are disabled
        }

        const response = await fetch('/gps_data');
        const data = await response.json();
        console.log("Fetched data: ", data);

        if (data.gps1.latitude !== null && data.gps1.longitude !== null) {
            const latLng1 = [data.gps1.latitude, data.gps1.longitude];
            marker1.setLatLng(latLng1);
            device1Path.push(latLng1);
            tracePolyline1.setLatLngs(device1Path);
            document.getElementById('gps1Status').style.color = 'green'; // Connected indicator
        } else {
            marker1.setLatLng([0, 0]); // Set marker position to a default (e.g., center of the map)
            device1Path = [];
            tracePolyline1.setLatLngs(device1Path);
            document.getElementById('gps1Status').style.color = 'red'; // Disconnected indicator
        }

        if (data.gps2.latitude !== null && data.gps2.longitude !== null) {
            const latLng2 = [data.gps2.latitude, data.gps2.longitude];
            marker2.setLatLng(latLng2);
            device2Path.push(latLng2);
            tracePolyline2.setLatLngs(device2Path);
            document.getElementById('gps2Status').style.color = 'green'; // Connected indicator
        } else {
            marker2.setLatLng([0, 0]); // Set marker position to a default (e.g., center of the map)
            device2Path = [];
            tracePolyline2.setLatLngs(device2Path);
            document.getElementById('gps2Status').style.color = 'red'; // Disconnected indicator
        }

        if (!data.gps1.latitude && !data.gps2.latitude) {
            stopTimer(); // Stop timer if all GPS connections are stopped
        }

        document.getElementById('resetButton').addEventListener('click', () => {
            device1Path = [];
            device2Path = [];
            tracePolyline1.setLatLngs([]);
            tracePolyline2.setLatLngs([]);
        });
}


        function startTimer() {
            timerInterval = setInterval(() => {
                timeElapsed += 1;
                document.getElementById('timer').textContent = `Time: ${timeElapsed}s`;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            document.getElementById('timer').textContent = 'Time: 0s';
            timeElapsed = 0;
        }

        async function startRecording() {
            await fetch('/start_recording', { method: 'POST' });
            console.log("Started recording");
            startTimer();
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('recordingTime').textContent = ''; // Clear previous recording time
        }

        async function stopRecording() {
            await fetch('/stop_recording', { method: 'POST' });
            console.log("Stopped recording");
            stopTimer();
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }

        async function uploadTrace() {
            
            const fileInput = document.getElementById('traceFileInput');
            const file = fileInput.files[0];
            if (!file) {
                alert("Please select a file.");
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch('/upload_trace', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            const traces1 = data.traces1;
            const traces2 = data.traces2;

            if (tracePolyline1) {
                map.removeLayer(tracePolyline1);
            }
            if (tracePolyline2) {
                map.removeLayer(tracePolyline2);
            }
            tracePolyline11 = L.polyline(traces1, { color: 'blue' }).addTo(map);
            tracePolyline22 = L.polyline(traces2, { color: 'red' }).addTo(map);
            if (traces1.length > 0 || traces2.length > 0) {
                map.fitBounds([...tracePolyline1.getBounds().toArray(), ...tracePolyline2.getBounds().toArray()]);
            }
        }

        async function browseTraces() {
            const response = await fetch('/list_traces');
            const traceFiles = await response.json();
            console.log("Fetched trace files: ", traceFiles);
            const traceListDiv = document.getElementById('traceList');
            traceListDiv.innerHTML = ''; // Clear previous list
            traceFiles.forEach(traceFile => {
                const traceFileName = traceFile.split('/').pop(); // Get only the file name
                const traceItem = document.createElement('div');
                traceItem.textContent = traceFileName;
                traceItem.style.cursor = 'pointer';
                traceItem.onclick = () => loadTrace(traceFileName); // Use only the file name
                traceListDiv.appendChild(traceItem);
            });
            traceListDiv.style.display = 'block';
        }

        async function loadTrace(traceFile) {
            stopAllGPS();
            const response = await fetch(`/get_trace/${traceFile}`);
            const traceData = await response.json();
            const traces1 = traceData.traces1;
            const traces2 = traceData.traces2;
            const duration = traceData.duration;
            const distance = traceData.distance;
            console.log("Loaded trace: ", traces1, traces2);

            // Update tracePolyline1 and tracePolyline2 with new coordinates
            tracePolyline1.setLatLngs(traces1);
            tracePolyline2.setLatLngs(traces2);

            // Fit map bounds to the new trace polylines
            if (traces1.length > 0 || traces2.length > 0) {
                map.fitBounds([...tracePolyline1.getBounds().toArray(), ...tracePolyline2.getBounds().toArray()]);
            }

            // Update duration and distance display
            document.getElementById('traceDuration').textContent = `Duration: ${duration.toFixed(2)} seconds`;
            document.getElementById('traceDistance').textContent = `Distance: ${(distance / 1000).toFixed(2)} kilometers`;
        }


        async function connectToGPS(deviceNum) {
            mapUpdateEnabled = true;
            const address = document.getElementById(`addressInput${deviceNum}`).value;
            const port = document.getElementById(`portInput${deviceNum}`).value;
            if (!address || !port) {
                alert('Please enter both address and port');
                return;
            }

            const response = await fetch('/connect_gps', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ address, port, deviceNum }),
            });

            if (response.ok) {
                console.log(`Connected to GPS ${deviceNum}`);
                document.getElementById(`gps${deviceNum}Status`).style.color = 'green'; // Change indicator to green
                document.getElementById('startBtn').disabled = false;
            } else {
                console.error(`Failed to connect to GPS ${deviceNum}`);
            }
        }

        async function stopAllGPS() {
            mapUpdateEnabled = false;
            const response = await fetch('/stop_all_gps', { method: 'POST' });
            if (response.ok) {
                console.log("Stopped all GPS connections and updates");
                document.getElementById('startBtn').disabled = true; // Disable start recording button
                document.getElementById('stopBtn').disabled = true; // Disable stop recording button
                document.getElementById('gps1Status').style.color = 'red'; // Reset GPS 1 indicator to red
                document.getElementById('gps2Status').style.color = 'red'; // Reset GPS 2 indicator to red

                // Clear markers and paths
                marker1.setLatLng([0, 0]); // Set marker position to a default (e.g., center of the map)
                marker2.setLatLng([0, 0]); // Set marker position to a default (e.g., center of the map)
                device1Path = [];
                device2Path = [];
                tracePolyline1.setLatLngs([]);
                tracePolyline2.setLatLngs([]);

                stopTimer(); // Stop timer if running
            } else {
                console.error("Failed to stop all GPS connections and updates");
            }
        }


        document.getElementById('connectBtn1').addEventListener('click', () => connectToGPS(1));
        document.getElementById('connectBtn2').addEventListener('click', () => connectToGPS(2));
        document.getElementById('startBtn').addEventListener('click', startRecording);
        document.getElementById('stopBtn').addEventListener('click', stopRecording);
        document.getElementById('uploadTraceBtn').addEventListener('click', uploadTrace);
        document.getElementById('browseTracesBtn').addEventListener('click', browseTraces);

        setInterval(updateMap, 1000);
    </script>
</body>
</html>
